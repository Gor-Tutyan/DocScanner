<!DOCTYPE html>
<html lang="hy">
<head>
<meta charset="UTF-8">
<title>ՀՀ ID / Անձնագիր սկաներ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family:Arial,sans-serif;margin:0;padding:20px;background:#f0f2f5;text-align:center;}
  h1 {color:#1a3c8c;}
  select, button {padding:15px;font-size:18px;margin:10px;border-radius:8px;border:none;}
  select {background:#fff;width:90%;max-width:400px;}
  button {background:#0066ff;color:white;cursor:pointer;}
  button:disabled {background:#ccc;cursor:not-allowed;}
  video {width:100%;max-width:600px;border:4px solid #333;border-radius:12px;margin:20px 0;}
  #result {margin:30px auto;padding:20px;background:white;border-radius:12px;font-size:21px;text-align:left;display:inline-block;min-width:320px;box-shadow:0 4px 15px rgba(0,0,0,0.15);}
  .hidden {display:none;}
  #loading {color:#0066ff; font-style:italic;}
</style>
</head>
<body>

<h1>ՀՀ փաստաթղթի սկաներ</h1>
<small id="status">Բեռնում Tesseract-ը... (5-10 վայրկյան)</small><br><br>

<select id="docType">
  <option value="">— Ընտրեք փաստաթուղթը —</option>
  <option value="id">ID քարտ</option>
  <option value="passport">Անձնագիր</option>
</select><br>

<button id="startBtn" class="hidden" disabled>Միացնել տեսախցիկը</button>

<div id="scanner" class="hidden">
  <video id="video" playsinline autoplay muted></video><br>
  <button id="snap" disabled>Լուսանկարել և հանել ՖԻՕ-ն</button>
</div>

<div id="result"></div>

<script src="https://unpkg.com/@dynamsoft/dynamsoft-document-normalizer@1.2.10/dist/ddn.js"></script>
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<script>
let worker = null;
let stream = null;
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const snapBtn = document.getElementById('snap');

// Актуальный Tesseract (фикс 404)
Tesseract.createWorker('eng', 1, {
  workerPath: 'https://unpkg.com/tesseract.js@5.1.0/dist/worker.min.js',
  langPath: 'https://cdn.jsdelivr.net/npm/@tesseract.js-data/eng@1.0.0/4.0.0_best_int',
  corePath: 'https://unpkg.com/tesseract.js-core@5.1.0/tesseract-core.wasm.js',
}).then(w => {
  worker = w;
  statusEl.textContent = 'Պատրաստ է! Ընտրեք փաստաթուղթը։';
  startBtn.disabled = false;
  snapBtn.disabled = false;
  console.log('Tesseract готов!');
}).catch(error => {
  console.error('Tesseract ошибка:', error);
  statusEl.textContent = 'Փորձում fallback...';
  // Fallback без langPath
  Tesseract.createWorker('eng').then(w => {
    worker = w;
    statusEl.textContent = 'Պատրաստ (fallback)!';
    startBtn.disabled = false;
    snapBtn.disabled = false;
  }).catch(e => {
    statusEl.textContent = 'Սխալ. Վերագրեք էջը։';
    console.error('Fallback упал:', e);
  });
});

// Выбор
document.getElementById('docType').onchange = function() {
  const v = this.value;
  startBtn.classList.toggle('hidden', !v);
  if (v) startBtn.textContent = v === 'id' ? 'Սկան ID քարտ' : 'Սկան անձնագիր';
};

// Камера
startBtn.onclick = async () => {
  document.getElementById('scanner').classList.remove('hidden');
  startBtn.classList.add('hidden');
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  document.getElementById('video').srcObject = stream;
};

// Скан
snapBtn.onclick = async () => {
  if (!worker) {
    document.getElementById('result').innerHTML = 'Tesseract ещё не готов... Обновите страницу.';
    return;
  }

  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  let img = canvas.toDataURL();

  // Нормализация
  try {
    const r = await Dynamsoft.DDN.DocumentNormalizer.detect(canvas);
    if (r.length > 0) {
      const n = await Dynamsoft.DDN.DocumentNormalizer.normalize(canvas, r[0]);
      img = n.toDataURL();
    }
  } catch(e) {
    console.log('Нормализация пропущена:', e);
  }

  const { data: { text } } = await worker.recognize(img);

  let surname = '', given = '', patronymic = '';
  const lines = text.toUpperCase().split('\n');
  for (let i = 0; i < lines.length - 1; i++) {
    if (lines[i].includes('SURNAME')) surname = lines[i+1].trim();
    if (lines[i].includes('GIVEN') || lines[i].includes('NAME')) given = lines[i+1].trim();
    if (lines[i].includes('PATRONYMIC')) patronymic = lines[i+1].trim();
  }

  // Резерв (ФИО в одной строке)
  if (!given) {
    const fallback = text.match(/[A-Z]{2,30}\s+[A-Z]{2,30}(\s+[A-Z]{2,30})?/i);
    if (fallback) {
      const p = fallback[0].trim().split(/\s+/);
      surname = p[0];
      given = p[1];
      patronymic = p[2] || '';
    }
  }

  const out = document.getElementById('result');
  const type = document.getElementById('docType').value;
  out.innerHTML = surname || given ?
    `<b>${type === 'id' ? 'ID քարտ' : 'Անձնագիր'}</b><br><br>
     Ազգանուն: <b>${surname}</b><br>
     Անուն:     <b>${given}</b><br>
     Հայրական: <b>${patronymic}</b>` :
    `Չհաջողվեց. Փորձեք լավ լույսի տակ.<br><small>Raw OCR: ${text.substring(0, 150)}...</small>`;
};
</script>
</body>
</html>